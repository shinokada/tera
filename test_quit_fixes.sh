#!/bin/bash
# Test the quit functionality fixes

echo "üîß Building with quit fixes..."
make clean
make build

if [ ! -f "./tera" ]; then
    echo "‚ùå Build failed!"
    exit 1
fi

echo "‚úÖ Build successful!"
echo ""
echo "üìã Quit Fixes:"
echo "  1. ‚úÖ 'q' key works from main menu (any menu position)"
echo "  2. ‚úÖ Search play ‚Üí q ‚Üí Player stops AND save prompt shows"
echo ""
echo "üß™ Manual Tests:"
echo ""
echo "Test 1 - Main Menu Quit:"
echo "  ‚Ä¢ Run: ./tera"
echo "  ‚Ä¢ Navigate to any menu item (not just Exit)"
echo "  ‚Ä¢ Press 'q'"
echo "  ‚Ä¢ Expected: Application quits immediately"
echo "  ‚Ä¢ Verify: No error messages"
echo ""
echo "Test 2 - Search Play Quit (Main Fix):"
echo "  ‚Ä¢ Run: ./tera"
echo "  ‚Ä¢ Press 2 (Search)"
echo "  ‚Ä¢ Search for a station"
echo "  ‚Ä¢ Select and play a station"
echo "  ‚Ä¢ Wait for audio to start"
echo "  ‚Ä¢ Press 'q'"
echo "  ‚Ä¢ Expected: Audio stops IMMEDIATELY"
echo "  ‚Ä¢ Expected: Save prompt appears"
echo "  ‚Ä¢ Verify: ps aux | grep mpv (should be empty)"
echo ""
echo "Test 3 - Verify No Zombie Process:"
echo "  ‚Ä¢ After Test 2"
echo "  ‚Ä¢ Run: ps aux | grep mpv"
echo "  ‚Ä¢ Expected: No MPV processes running"
echo "  ‚Ä¢ Expected: Only the grep command shows up"
echo ""
echo "Test 4 - Play from Favorites Quit:"
echo "  ‚Ä¢ Run: ./tera"
echo "  ‚Ä¢ Press 1 (Play from Favorites)"
echo "  ‚Ä¢ Select a list and station"
echo "  ‚Ä¢ Press 'q'"
echo "  ‚Ä¢ Expected: Audio stops"
echo "  ‚Ä¢ Expected: Returns to station list"
echo "  ‚Ä¢ Verify: No zombie process"
echo ""
echo "Test 5 - Complete Flow:"
echo "  ‚Ä¢ Search ‚Üí Play ‚Üí Press q"
echo "  ‚Ä¢ Choose 'y' to save"
echo "  ‚Ä¢ Return to main menu"
echo "  ‚Ä¢ Press 'q' to quit"
echo "  ‚Ä¢ Expected: Clean exit, no audio playing"
echo ""
echo "üöÄ Ready to test! Run: ./tera"
echo ""
echo "‚ö†Ô∏è  IMPORTANT CHECKS:"
echo "  1. Audio stops when pressing q (not after quit)"
echo "  2. Save prompt appears after audio stops"
echo "  3. No orphan MPV processes"
echo "  4. q works from any position in main menu"
